name: é–‹ç™¼ç’°å¢ƒ CI/CD

on:
  push:
    branches: [develop, feature/*]
  pull_request:
    branches: [develop]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½²ï¼ˆè·³éŽæ¸¬è©¦ï¼‰'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'è·³éŽæ¸¬è©¦'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  ENVIRONMENT: 'development'

jobs:
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ä»£ç¢¼å“è³ªæª¢æŸ¥
    timeout-minutes: 10

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é¡žåž‹æª¢æŸ¥
        run: pnpm type-check
        if: ${{ !inputs.skip_tests }}

      - name: ä»£ç¢¼é¢¨æ ¼æª¢æŸ¥
        run: pnpm lint:check
        if: ${{ !inputs.skip_tests }}

      - name: ä»£ç¢¼æ ¼å¼åŒ–æª¢æŸ¥
        run: pnpm format:check
        if: ${{ !inputs.skip_tests }}

  # æ§‹å»ºå’Œæ¸¬è©¦
  build-and-test:
    needs: code-quality
    runs-on: ubuntu-latest
    name: æ§‹å»ºå’Œæ¸¬è©¦
    timeout-minutes: 15

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: æ§‹å»ºåŸºç¤ŽåŒ…
        run: |
          echo "ðŸ”¨ æ§‹å»ºåŸºç¤ŽåŒ…..."
          pnpm build:types
          pnpm build:ui

      - name: æ§‹å»ºå‰ç«¯
        run: |
          echo "ðŸŒ æ§‹å»ºå‰ç«¯æ‡‰ç”¨..."
          pnpm build:web

      - name: æ§‹å»º API
        run: |
          echo "ðŸ”Œ æ§‹å»º API æœå‹™..."
          pnpm build:api

      - name: é‹è¡Œæ¸¬è©¦
        run: |
          echo "ðŸ§ª é‹è¡Œæ¸¬è©¦..."
          pnpm test:ci
        if: ${{ !inputs.skip_tests }}

      - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹çŽ‡
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
        if: ${{ !inputs.skip_tests }}

      - name: å‰µå»ºéƒ¨ç½²åŒ…
        run: |
          echo "ðŸ“¦ å‰µå»ºéƒ¨ç½²åŒ…..."
          mkdir -p deployment

          # è¤‡è£½æ§‹å»ºç”¢ç‰©
          cp -r apps/web/.next deployment/web/
          cp -r apps/api/dist deployment/api/
          cp -r packages/types/dist deployment/types/
          cp -r packages/ui/dist deployment/ui/

          # è¤‡è£½é…ç½®æ–‡ä»¶
          cp -r config deployment/
          cp -r scripts deployment/
          cp package.json deployment/
          cp pnpm-lock.yaml deployment/
          cp pnpm-workspace.yaml deployment/

          # å‰µå»ºéƒ¨ç½²ä¿¡æ¯
          cat > deployment/deployment-info.txt << EOF
          éƒ¨ç½²æ™‚é–“: $(date)
          Git æäº¤: ${{ github.sha }}
          åˆ†æ”¯: ${{ github.ref_name }}
          è§¸ç™¼è€…: ${{ github.actor }}
          ç’°å¢ƒ: ${{ env.ENVIRONMENT }}
          EOF

          echo "âœ… éƒ¨ç½²åŒ…å‰µå»ºå®Œæˆ"

  # éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
  deploy-dev:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
    environment: development
    timeout-minutes: 20

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ä¸‹è¼‰éƒ¨ç½²åŒ…
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: éƒ¨ç½²å‰ç«¯åˆ° Vercel é–‹ç™¼ç’°å¢ƒ
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN_DEV }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID_DEV }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_DEV }}
          # é–‹ç™¼ç’°å¢ƒéƒ¨ç½²åˆ°å°ˆæ¡ˆçš„ç”Ÿç”¢ç’°å¢ƒï¼ˆç©©å®šç‰ˆæœ¬ï¼‰
          vercel-args: '--prod'
          working-directory: ./apps/web

      - name: éƒ¨ç½² API åˆ° Cloudflare é–‹ç™¼ç’°å¢ƒ
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN_DEV }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID_DEV }}
          command: deploy
          environment: development
          working-directory: ./apps/api

      - name: éƒ¨ç½²æ•¸æ“šç®¡é“
        run: |
          echo "ðŸ“Š éƒ¨ç½²æ•¸æ“šç®¡é“..."
          cd deployment

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ•¸æ“šç®¡é“éƒ¨ç½²é‚è¼¯
          # ä¾‹å¦‚ï¼šéƒ¨ç½²åˆ° Docker å®¹å™¨ã€é›²æœå‹™ç­‰
          echo "æ•¸æ“šç®¡é“éƒ¨ç½²å®Œæˆ"

      - name: æ›´æ–°éƒ¨ç½²ç‹€æ…‹
        run: |
          echo "âœ… é–‹ç™¼ç’°å¢ƒéƒ¨ç½²å®Œæˆ"
          echo "éƒ¨ç½²å®Œæˆæ™‚é–“: $(date)"

          # å‰µå»ºéƒ¨ç½²ç‹€æ…‹æ–‡ä»¶
          cat > deployment/deployment-status.json << EOF
          {
            "status": "success",
            "environment": "${{ env.ENVIRONMENT }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_commit": "${{ github.sha }}",
            "git_branch": "${{ github.ref_name }}",
            "triggered_by": "${{ github.actor }}",
            "workflow": "${{ github.workflow }}"
          }
          EOF

  # éƒ¨ç½²å¾Œé©—è­‰
  post-deploy-verification:
    needs: deploy-dev
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å¾Œé©—è­‰
    timeout-minutes: 10

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ç­‰å¾…æœå‹™å•Ÿå‹•
        run: |
          echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
          sleep 30

      - name: å¥åº·æª¢æŸ¥
        run: |
          echo "ðŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."

          # æª¢æŸ¥ API æœå‹™
          echo "æª¢æŸ¥ API æœå‹™..."
          # curl -f https://dev-api.concept-stock-screener.com/health || echo "API æœå‹™æª¢æŸ¥å¤±æ•—"

          # æª¢æŸ¥å‰ç«¯æœå‹™
          echo "æª¢æŸ¥å‰ç«¯æœå‹™..."
          # curl -f https://dev.concept-stock-screener.com || echo "å‰ç«¯æœå‹™æª¢æŸ¥å¤±æ•—"

          echo "å¥åº·æª¢æŸ¥å®Œæˆ"

      - name: åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
        run: |
          echo "ðŸ§ª åŸ·è¡ŒåŸºæœ¬åŠŸèƒ½æ¸¬è©¦..."

          # é€™è£¡å¯ä»¥æ·»åŠ åŸºæœ¬çš„ API ç«¯é»žæ¸¬è©¦
          # ä¾‹å¦‚ï¼šæ¸¬è©¦æœç´¢ã€è‚¡ç¥¨è©³æƒ…ç­‰ç«¯é»ž

          echo "åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å®Œæˆ"

      - name: æ›´æ–°é©—è­‰ç‹€æ…‹
        run: |
          echo "âœ… éƒ¨ç½²å¾Œé©—è­‰å®Œæˆ"
          echo "é©—è­‰æ™‚é–“: $(date)"

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    needs: [deploy-dev, post-deploy-verification]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²é€šçŸ¥
    if: always()

    steps:
      - name: ç™¼é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: needs.deploy-dev.result == 'success' && needs.post-deploy-verification.result == 'success'
        run: |
          echo "ðŸŽ‰ é–‹ç™¼ç’°å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "éƒ¨ç½²æ™‚é–“: $(date)"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è§¸ç™¼è€…: ${{ github.actor }}"

          # é€™è£¡å¯ä»¥æ·»åŠ é€šçŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šç™¼é€ Slack é€šçŸ¥ã€éƒµä»¶ç­‰

      - name: ç™¼é€éƒ¨ç½²å¤±æ•—é€šçŸ¥
        if: needs.deploy-dev.result == 'failure' || needs.post-deploy-verification.result == 'failure'
        run: |
          echo "âŒ é–‹ç™¼ç’°å¢ƒéƒ¨ç½²å¤±æ•—"
          echo "å¤±æ•—æ™‚é–“: $(date)"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è§¸ç™¼è€…: ${{ github.actor }}"

          # é€™è£¡å¯ä»¥æ·»åŠ å¤±æ•—é€šçŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šç™¼é€ Slack è­¦å ±ã€éƒµä»¶ç­‰

      - name: å‰µå»ºéƒ¨ç½²æ‘˜è¦
        run: |
          echo "ðŸ“Š éƒ¨ç½²æ‘˜è¦"
          echo "================"
          echo "ç’°å¢ƒ: ${{ env.ENVIRONMENT }}"
          echo "éƒ¨ç½²ç‹€æ…‹: ${{ needs.deploy-dev.result || 'skipped' }}"
          echo "é©—è­‰ç‹€æ…‹: ${{ needs.post-deploy-verification.result || 'skipped' }}"
          echo "ç¸½é«”çµæžœ: ${{ job.status }}"
          echo "å®Œæˆæ™‚é–“: $(date)"
