name: ?�產?��??�署

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_message:
        description: '?�署說�?'
        required: false
        default: '?��?觸發?�產?��??�署'
        type: string

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'
  ENVIRONMENT: 'production'

jobs:
  # ?�署?��??�環�?
  deploy-production:
    runs-on: ubuntu-latest
    name: ?�署?��??�環�?
    environment: production
    timeout-minutes: 30

    steps:
      - name: 檢出�?��
        uses: actions/checkout@v4

      - name: 構建?�署??
        run: |
          echo "?�� 構建?�產?��??�署??.."

          # 安�?依賴
          pnpm install --frozen-lockfile

          # 構建?��???
          pnpm build:types
          pnpm build:ui

          # 構建?�端
          pnpm build:web

          # 構建 API
          pnpm build:api

          # ?�建?�署??
          mkdir -p deployment
          cp -r apps/web/.next deployment/web/
          cp -r apps/api/dist deployment/api/
          cp -r packages/types/dist deployment/types/
          cp -r packages/ui/dist deployment/ui/

          # 複製?�置?�件
          cp -r config deployment/
          cp -r scripts deployment/
          cp package.json deployment/
          cp pnpm-lock.yaml deployment/
          cp pnpm-workspace.yaml deployment/

          echo "???�產?��??�署?��?建�???

      - name: ?�署?�端??Vercel ?�產?��?
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN_PROD }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
          # ?�產?��??�署?��?案�??�產?��?
          vercel-args: '--prod'
          working-directory: ./deployment/web

      - name: ���p API �� Cloudflare �Ͳ�����
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: pnpm --filter api deploy -- --env production

      - name: ?�署?��?管�?
        run: |
          echo "?? ?�署?��?管�??��??�環�?.."
          cd deployment

          # ?�裡?�以添�?實�??�數?�管?�部署�?�?
          # 例�?：部署到 Docker 容器?�雲?��?�?
          echo "?��?管�??�產?��??�署完�?"

      - name: ?�新?�署?�??
        run: |
          echo "???�產?��??�署完�?"
          echo "?�署完�??��?: $(date)"
          echo "?�署說�?: ${{ inputs.deploy_message }}"

          # ?�建?�署?�?��?�?
          cat > deployment/production-deployment-status.json << EOF
          {
            "status": "success",
            "environment": "${{ env.ENVIRONMENT }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_commit": "${{ github.sha }}",
            "git_branch": "${{ github.ref_name }}",
            "triggered_by": "${{ github.actor }}",
            "workflow": "${{ github.workflow }}",
            "deploy_message": "${{ inputs.deploy_message }}"
          }
          EOF

  # ?�產?��??�署後�?�?
  post-deploy-verification:
    needs: deploy-production
    runs-on: ubuntu-latest
    name: ?�產?��??�署後�?�?
    timeout-minutes: 15

    steps:
      - name: 等�??��??��?
        run: |
          echo "??等�??�產?��??��??��?..."
          sleep 45

      - name: ?�產?��??�康檢查
        run: |
          echo "?�� ?��??�產?��??�康檢查..."

          # 檢查 API ?��?
          echo "檢查?�產?��? API ?��?..."
          # curl -f https://api.concept-stock-screener.com/health || echo "?�產?��? API ?��?檢查失�?"

          # 檢查?�端?��?
          echo "檢查?�產?��??�端?��?..."
          # curl -f https://concept-stock-screener.com || echo "?�產?��??�端?��?檢查失�?"

          echo "?�產?��??�康檢查完�?"

      - name: ?�產?��??�能測試
        run: |
          echo "?�� ?��??�產?��??�能測試..."

          # ?�裡?�以添�??�產?��???API 端�?測試
          # 例�?：測試�?索、股票詳?��?端�?

          echo "?�產?��??�能測試完�?"

      - name: ?�能測試
        run: |
          echo "???��??�產?��??�能測試..."

          # ?�裡?�以添�??�能測試?�輯
          # 例�?：響?��??�、�??��?�?

          echo "?�產?��??�能測試完�?"

      - name: ?�新驗�??�??
        run: |
          echo "???�產?��??�署後�?證�???

  # ?�署?�知
  deployment-notification:
    needs: [deploy-production, post-deploy-verification]
    runs-on: ubuntu-latest
    name: ?�署?�知
    if: always()

    steps:
      - name: ?�送部署通知
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ] && [ "${{ needs.post-deploy-verification.result }}" == "success" ]; then
            echo "?? ?�產?��??�署?��?�?
            echo "?�署說�?: ${{ inputs.deploy_message }}"
            echo "?�署?? ${{ github.actor }}"
            echo "?�署?��?: $(date)"
          else
            echo "???�產?��??�署失�?"
            echo "?�署?�?? ${{ needs.deploy-production.result }}"
            echo "驗�??�?? ${{ needs.post-deploy-verification.result }}"
          fi
