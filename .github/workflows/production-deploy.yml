name: ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'éƒ¨ç½²èªªæ˜Ž'
        required: false
        default: 'æ‰‹å‹•è§¸ç™¼ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²'
        type: string

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'
  ENVIRONMENT: 'production'

jobs:
  # éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-production:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    environment: production
    timeout-minutes: 30

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: æ§‹å»ºéƒ¨ç½²åŒ…
        run: |
          echo "ðŸ”¨ æ§‹å»ºç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²åŒ…..."

          # å®‰è£ä¾è³´
          pnpm install --frozen-lockfile

          # æ§‹å»ºåŸºç¤ŽåŒ…
          pnpm build:types
          pnpm build:ui

          # æ§‹å»ºå‰ç«¯
          pnpm build:web

          # æ§‹å»º API
          pnpm build:api

          # å‰µå»ºéƒ¨ç½²åŒ…
          mkdir -p deployment
          cp -r apps/web/.next deployment/web/
          cp -r apps/api/dist deployment/api/
          cp -r packages/types/dist deployment/types/
          cp -r packages/ui/dist deployment/ui/

          # è¤‡è£½é…ç½®æ–‡ä»¶
          cp -r config deployment/
          cp -r scripts deployment/
          cp package.json deployment/
          cp pnpm-lock.yaml deployment/
          cp pnpm-workspace.yaml deployment/

          echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²åŒ…æ§‹å»ºå®Œæˆ"

      - name: éƒ¨ç½²å‰ç«¯åˆ° Vercel ç”Ÿç”¢ç’°å¢ƒ
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN_PROD }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
          # ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²åˆ°å°ˆæ¡ˆçš„ç”Ÿç”¢ç’°å¢ƒ
          vercel-args: '--prod'
          working-directory: ./deployment/web

      - name: éƒ¨ç½² API åˆ° Cloudflare ç”Ÿç”¢ç’°å¢ƒ
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          environment: production
          working-directory: ./deployment/api

      - name: éƒ¨ç½²æ•¸æ“šç®¡é“
        run: |
          echo "ðŸ“Š éƒ¨ç½²æ•¸æ“šç®¡é“åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
          cd deployment

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ•¸æ“šç®¡é“éƒ¨ç½²é‚è¼¯
          # ä¾‹å¦‚ï¼šéƒ¨ç½²åˆ° Docker å®¹å™¨ã€é›²æœå‹™ç­‰
          echo "æ•¸æ“šç®¡é“ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: æ›´æ–°éƒ¨ç½²ç‹€æ…‹
        run: |
          echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆ"
          echo "éƒ¨ç½²å®Œæˆæ™‚é–“: $(date)"
          echo "éƒ¨ç½²èªªæ˜Ž: ${{ inputs.deploy_message }}"

          # å‰µå»ºéƒ¨ç½²ç‹€æ…‹æ–‡ä»¶
          cat > deployment/production-deployment-status.json << EOF
          {
            "status": "success",
            "environment": "${{ env.ENVIRONMENT }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_commit": "${{ github.sha }}",
            "git_branch": "${{ github.ref_name }}",
            "triggered_by": "${{ github.actor }}",
            "workflow": "${{ github.workflow }}",
            "deploy_message": "${{ inputs.deploy_message }}"
          }
          EOF

  # ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¾Œé©—è­‰
  post-deploy-verification:
    needs: deploy-production
    runs-on: ubuntu-latest
    name: ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¾Œé©—è­‰
    timeout-minutes: 15

    steps:
      - name: ç­‰å¾…æœå‹™å•Ÿå‹•
        run: |
          echo "â³ ç­‰å¾…ç”Ÿç”¢ç’°å¢ƒæœå‹™å•Ÿå‹•..."
          sleep 45

      - name: ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥
        run: |
          echo "ðŸ¥ åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥..."

          # æª¢æŸ¥ API æœå‹™
          echo "æª¢æŸ¥ç”Ÿç”¢ç’°å¢ƒ API æœå‹™..."
          # curl -f https://api.concept-stock-screener.com/health || echo "ç”Ÿç”¢ç’°å¢ƒ API æœå‹™æª¢æŸ¥å¤±æ•—"

          # æª¢æŸ¥å‰ç«¯æœå‹™
          echo "æª¢æŸ¥ç”Ÿç”¢ç’°å¢ƒå‰ç«¯æœå‹™..."
          # curl -f https://concept-stock-screener.com || echo "ç”Ÿç”¢ç’°å¢ƒå‰ç«¯æœå‹™æª¢æŸ¥å¤±æ•—"

          echo "ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥å®Œæˆ"

      - name: ç”Ÿç”¢ç’°å¢ƒåŠŸèƒ½æ¸¬è©¦
        run: |
          echo "ðŸ§ª åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒåŠŸèƒ½æ¸¬è©¦..."

          # é€™è£¡å¯ä»¥æ·»åŠ ç”Ÿç”¢ç’°å¢ƒçš„ API ç«¯é»žæ¸¬è©¦
          # ä¾‹å¦‚ï¼šæ¸¬è©¦æœç´¢ã€è‚¡ç¥¨è©³æƒ…ç­‰ç«¯é»ž

          echo "ç”Ÿç”¢ç’°å¢ƒåŠŸèƒ½æ¸¬è©¦å®Œæˆ"

      - name: æ€§èƒ½æ¸¬è©¦
        run: |
          echo "âš¡ åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒæ€§èƒ½æ¸¬è©¦..."

          # é€™è£¡å¯ä»¥æ·»åŠ æ€§èƒ½æ¸¬è©¦é‚è¼¯
          # ä¾‹å¦‚ï¼šéŸ¿æ‡‰æ™‚é–“ã€åžåé‡ç­‰

          echo "ç”Ÿç”¢ç’°å¢ƒæ€§èƒ½æ¸¬è©¦å®Œæˆ"

      - name: æ›´æ–°é©—è­‰ç‹€æ…‹
        run: |
          echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¾Œé©—è­‰å®Œæˆ"

  # éƒ¨ç½²é€šçŸ¥
  deployment-notification:
    needs: [deploy-production, post-deploy-verification]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²é€šçŸ¥
    if: always()

    steps:
      - name: ç™¼é€éƒ¨ç½²é€šçŸ¥
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ] && [ "${{ needs.post-deploy-verification.result }}" == "success" ]; then
            echo "ðŸŽ‰ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            echo "éƒ¨ç½²èªªæ˜Ž: ${{ inputs.deploy_message }}"
            echo "éƒ¨ç½²è€…: ${{ github.actor }}"
            echo "éƒ¨ç½²æ™‚é–“: $(date)"
          else
            echo "âŒ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¤±æ•—"
            echo "éƒ¨ç½²ç‹€æ…‹: ${{ needs.deploy-production.result }}"
            echo "é©—è­‰ç‹€æ…‹: ${{ needs.post-deploy-verification.result }}"
          fi
