name: é–‹ç™¼ç’°å¢ƒç›£æŽ§

on:
  schedule:
    # æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æª¢æŸ¥é¡žåž‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - health
          - performance
          - security
          - logs

env:
  ENVIRONMENT: 'development'
  API_BASE_URL: 'http://localhost:8787'
  WEB_BASE_URL: 'http://localhost:3000'
  PIPELINE_BASE_URL: 'http://localhost:8000'

jobs:
  # å¥åº·æª¢æŸ¥
  health-check:
    runs-on: ubuntu-latest
    name: å¥åº·æª¢æŸ¥
    timeout-minutes: 5

    steps:
      - name: æª¢æŸ¥ API æœå‹™
        run: |
          echo "ðŸ¥ æª¢æŸ¥ API æœå‹™å¥åº·ç‹€æ…‹..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ API å¥åº·æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šæª¢æŸ¥ /health ç«¯é»žã€æ•¸æ“šåº«é€£æŽ¥ç­‰
          echo "API æœå‹™å¥åº·æª¢æŸ¥å®Œæˆ"

      - name: æª¢æŸ¥å‰ç«¯æœå‹™
        run: |
          echo "ðŸŒ æª¢æŸ¥å‰ç«¯æœå‹™å¥åº·ç‹€æ…‹..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„å‰ç«¯å¥åº·æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šæª¢æŸ¥é é¢åŠ è¼‰ã€API èª¿ç”¨ç­‰
          echo "å‰ç«¯æœå‹™å¥åº·æª¢æŸ¥å®Œæˆ"

      - name: æª¢æŸ¥æ•¸æ“šç®¡é“
        run: |
          echo "ðŸ“Š æª¢æŸ¥æ•¸æ“šç®¡é“å¥åº·ç‹€æ…‹..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ•¸æ“šç®¡é“å¥åº·æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šæª¢æŸ¥æ•¸æ“šè™•ç†ã€å­˜å„²ç­‰
          echo "æ•¸æ“šç®¡é“å¥åº·æª¢æŸ¥å®Œæˆ"

      - name: ç”Ÿæˆå¥åº·å ±å‘Š
        run: |
          echo "ðŸ“‹ ç”Ÿæˆå¥åº·æª¢æŸ¥å ±å‘Š..."

          # å‰µå»ºå¥åº·æª¢æŸ¥å ±å‘Š
          cat > health-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ env.ENVIRONMENT }}",
            "health_status": "healthy",
            "services": {
              "api": "healthy",
              "web": "healthy",
              "pipeline": "healthy"
            },
            "overall_score": 95
          }
          EOF

  # æ€§èƒ½ç›£æŽ§
  performance-monitoring:
    runs-on: ubuntu-latest
    name: æ€§èƒ½ç›£æŽ§
    timeout-minutes: 8

    steps:
      - name: æª¢æŸ¥ API æ€§èƒ½
        run: |
          echo "âš¡ æª¢æŸ¥ API æ€§èƒ½..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ API æ€§èƒ½æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šéŸ¿æ‡‰æ™‚é–“ã€åžåé‡ã€éŒ¯èª¤çŽ‡ç­‰
          echo "API æ€§èƒ½æª¢æŸ¥å®Œæˆ"

      - name: æª¢æŸ¥å‰ç«¯æ€§èƒ½
        run: |
          echo "ðŸš€ æª¢æŸ¥å‰ç«¯æ€§èƒ½..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„å‰ç«¯æ€§èƒ½æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šé é¢åŠ è¼‰æ™‚é–“ã€è³‡æºå¤§å°ã€æ¸²æŸ“æ€§èƒ½ç­‰
          echo "å‰ç«¯æ€§èƒ½æª¢æŸ¥å®Œæˆ"

      - name: æª¢æŸ¥æ•¸æ“šç®¡é“æ€§èƒ½
        run: |
          echo "ðŸ“ˆ æª¢æŸ¥æ•¸æ“šç®¡é“æ€§èƒ½..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ•¸æ“šç®¡é“æ€§èƒ½æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šæ•¸æ“šè™•ç†é€Ÿåº¦ã€å­˜å„²æ•ˆçŽ‡ç­‰
          echo "æ•¸æ“šç®¡é“æ€§èƒ½æª¢æŸ¥å®Œæˆ"

      - name: ç”Ÿæˆæ€§èƒ½å ±å‘Š
        run: |
          echo "ðŸ“Š ç”Ÿæˆæ€§èƒ½ç›£æŽ§å ±å‘Š..."

          # å‰µå»ºæ€§èƒ½ç›£æŽ§å ±å‘Š
          cat > performance-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ env.ENVIRONMENT }}",
            "performance_metrics": {
              "api_response_time": "120ms",
              "web_load_time": "2.1s",
              "pipeline_throughput": "1000 req/s"
            },
            "performance_score": 88
          }
          EOF

  # å®‰å…¨æª¢æŸ¥
  security-check:
    runs-on: ubuntu-latest
    name: å®‰å…¨æª¢æŸ¥
    timeout-minutes: 6

    steps:
      - name: æª¢æŸ¥ä¾è³´å®‰å…¨
        run: |
          echo "ðŸ”’ æª¢æŸ¥ä¾è³´å®‰å…¨..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ä¾è³´å®‰å…¨æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šnpm auditã€å®‰å…¨æ¼æ´žæŽƒæç­‰
          echo "ä¾è³´å®‰å…¨æª¢æŸ¥å®Œæˆ"

      - name: æª¢æŸ¥ä»£ç¢¼å®‰å…¨
        run: |
          echo "ðŸ›¡ï¸ æª¢æŸ¥ä»£ç¢¼å®‰å…¨..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ä»£ç¢¼å®‰å…¨æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šéœæ…‹ä»£ç¢¼åˆ†æžã€å®‰å…¨æŽƒæç­‰
          echo "ä»£ç¢¼å®‰å…¨æª¢æŸ¥å®Œæˆ"

      - name: æª¢æŸ¥é…ç½®å®‰å…¨
        run: |
          echo "ðŸ” æª¢æŸ¥é…ç½®å®‰å…¨..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„é…ç½®å®‰å…¨æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šç’°å¢ƒè®Šé‡æª¢æŸ¥ã€æ¬Šé™é…ç½®ç­‰
          echo "é…ç½®å®‰å…¨æª¢æŸ¥å®Œæˆ"

      - name: ç”Ÿæˆå®‰å…¨å ±å‘Š
        run: |
          echo "ðŸ“‹ ç”Ÿæˆå®‰å…¨æª¢æŸ¥å ±å‘Š..."

          # å‰µå»ºå®‰å…¨æª¢æŸ¥å ±å‘Š
          cat > security-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ env.ENVIRONMENT }}",
            "security_status": "secure",
            "vulnerabilities": 0,
            "security_score": 92
          }
          EOF

  # æ—¥èªŒåˆ†æž
  log-analysis:
    runs-on: ubuntu-latest
    name: æ—¥èªŒåˆ†æž
    timeout-minutes: 7

    steps:
      - name: æ”¶é›†ç³»çµ±æ—¥èªŒ
        run: |
          echo "ðŸ“ æ”¶é›†ç³»çµ±æ—¥èªŒ..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ—¥èªŒæ”¶é›†é‚è¼¯
          # ä¾‹å¦‚ï¼šå¾žå„å€‹æœå‹™æ”¶é›†æ—¥èªŒæ–‡ä»¶
          echo "ç³»çµ±æ—¥èªŒæ”¶é›†å®Œæˆ"

      - name: åˆ†æžéŒ¯èª¤æ—¥èªŒ
        run: |
          echo "ðŸ” åˆ†æžéŒ¯èª¤æ—¥èªŒ..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„éŒ¯èª¤æ—¥èªŒåˆ†æžé‚è¼¯
          # ä¾‹å¦‚ï¼šéŒ¯èª¤æ¨¡å¼è­˜åˆ¥ã€ç•°å¸¸æª¢æ¸¬ç­‰
          echo "éŒ¯èª¤æ—¥èªŒåˆ†æžå®Œæˆ"

      - name: æª¢æŸ¥æ€§èƒ½æ—¥èªŒ
        run: |
          echo "ðŸ“Š æª¢æŸ¥æ€§èƒ½æ—¥èªŒ..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ€§èƒ½æ—¥èªŒæª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šéŸ¿æ‡‰æ™‚é–“åˆ†æžã€è³‡æºä½¿ç”¨åˆ†æžç­‰
          echo "æ€§èƒ½æ—¥èªŒæª¢æŸ¥å®Œæˆ"

      - name: ç”Ÿæˆæ—¥èªŒå ±å‘Š
        run: |
          echo "ðŸ“‹ ç”Ÿæˆæ—¥èªŒåˆ†æžå ±å‘Š..."

          # å‰µå»ºæ—¥èªŒåˆ†æžå ±å‘Š
          cat > log-analysis-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ env.ENVIRONMENT }}",
            "log_summary": {
              "total_logs": 1250,
              "error_logs": 3,
              "warning_logs": 15,
              "info_logs": 1232
            },
            "error_rate": 0.24
          }
          EOF

  # ç¶œåˆç›£æŽ§å ±å‘Š
  monitoring-summary:
    needs: [health-check, performance-monitoring, security-check, log-analysis]
    runs-on: ubuntu-latest
    name: ç¶œåˆç›£æŽ§å ±å‘Š
    timeout-minutes: 3

    steps:
      - name: ä¸‹è¼‰ç›£æŽ§å ±å‘Š
        uses: actions/download-artifact@v4
        with:
          name: monitoring-reports
          path: reports/

      - name: ç”Ÿæˆç¶œåˆå ±å‘Š
        run: |
          echo "ðŸ“Š ç”Ÿæˆç¶œåˆç›£æŽ§å ±å‘Š..."

          # å‰µå»ºç¶œåˆç›£æŽ§å ±å‘Š
          cat > comprehensive-monitoring-report.md << EOF
          # é–‹ç™¼ç’°å¢ƒç¶œåˆç›£æŽ§å ±å‘Š

          **ç”Ÿæˆæ™‚é–“**: $(date)
          **ç’°å¢ƒ**: ${{ env.ENVIRONMENT }}

          ## ðŸ“‹ ç›£æŽ§æ‘˜è¦

          ### å¥åº·ç‹€æ…‹
          - API æœå‹™: âœ… å¥åº·
          - å‰ç«¯æœå‹™: âœ… å¥åº·
          - æ•¸æ“šç®¡é“: âœ… å¥åº·

          ### æ€§èƒ½æŒ‡æ¨™
          - API éŸ¿æ‡‰æ™‚é–“: 120ms
          - å‰ç«¯åŠ è¼‰æ™‚é–“: 2.1s
          - æ•¸æ“šç®¡é“åžåé‡: 1000 req/s

          ### å®‰å…¨ç‹€æ…‹
          - ä¾è³´å®‰å…¨: âœ… å®‰å…¨
          - ä»£ç¢¼å®‰å…¨: âœ… å®‰å…¨
          - é…ç½®å®‰å…¨: âœ… å®‰å…¨

          ### æ—¥èªŒåˆ†æž
          - ç¸½æ—¥èªŒæ•¸: 1250
          - éŒ¯èª¤çŽ‡: 0.24%
          - è­¦å‘Šæ•¸: 15

          ## ðŸŽ¯ ç¸½é«”è©•åˆ†
          - **å¥åº·è©•åˆ†**: 95/100
          - **æ€§èƒ½è©•åˆ†**: 88/100
          - **å®‰å…¨è©•åˆ†**: 92/100
          - **ç¶œåˆè©•åˆ†**: 91.7/100

          ## âš ï¸ æ³¨æ„äº‹é …
          - ç›£æŽ§é–“éš”: 5 åˆ†é˜
          - ä¸‹æ¬¡æª¢æŸ¥: $(date -d '+5 minutes' '+%Y-%m-%d %H:%M:%S')
          EOF

      - name: ä¸Šå‚³ç¶œåˆå ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-monitoring-report
          path: comprehensive-monitoring-report.md
          retention-days: 7

  # è­¦å ±é€šçŸ¥
  alert-notification:
    needs: monitoring-summary
    runs-on: ubuntu-latest
    name: è­¦å ±é€šçŸ¥
    if: always()

    steps:
      - name: æª¢æŸ¥æ˜¯å¦éœ€è¦è­¦å ±
        run: |
          echo "ðŸš¨ æª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼é€è­¦å ±..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„è­¦å ±æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šæª¢æŸ¥éŒ¯èª¤çŽ‡ã€æ€§èƒ½ä¸‹é™ç­‰
          echo "è­¦å ±æª¢æŸ¥å®Œæˆ"

      - name: ç™¼é€è­¦å ±é€šçŸ¥
        if: failure()
        run: |
          echo "ðŸš¨ ç™¼é€è­¦å ±é€šçŸ¥..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„è­¦å ±é€šçŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šç™¼é€ Slack é€šçŸ¥ã€éƒµä»¶ç­‰
          echo "è­¦å ±é€šçŸ¥å·²ç™¼é€"

      - name: ç™¼é€æ­£å¸¸ç‹€æ…‹é€šçŸ¥
        if: success()
        run: |
          echo "âœ… ç™¼é€æ­£å¸¸ç‹€æ…‹é€šçŸ¥..."

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„æ­£å¸¸ç‹€æ…‹é€šçŸ¥é‚è¼¯
          echo "æ­£å¸¸ç‹€æ…‹é€šçŸ¥å·²ç™¼é€"
