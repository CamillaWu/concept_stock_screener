name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # ä¾è³´å®‰è£å’Œé¡å‹æª¢æŸ¥
  setup-and-check:
    runs-on: ubuntu-latest
    name: ç’°å¢ƒè¨­ç½®å’Œæª¢æŸ¥

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é¡å‹æª¢æŸ¥
        run: pnpm type-check

      - name: ä»£ç¢¼é¢¨æ ¼æª¢æŸ¥
        run: pnpm lint:check

      - name: ä»£ç¢¼æ ¼å¼åŒ–æª¢æŸ¥
        run: pnpm format:check

  # æ§‹å»ºæ¸¬è©¦
  build:
    needs: setup-and-check
    runs-on: ubuntu-latest
    name: æ§‹å»ºå’Œæ¸¬è©¦

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: æ§‹å»ºåŸºç¤åŒ…
        run: |
          pnpm build:types
          pnpm build:ui

      - name: æ§‹å»ºå‰ç«¯
        run: pnpm build:web

      - name: æ§‹å»º API
        run: pnpm build:api

      - name: é‹è¡Œæ¸¬è©¦
        run: pnpm test:ci

      - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ä»£ç¢¼è³ªé‡æª¢æŸ¥
  code-quality:
    needs: setup-and-check
    runs-on: ubuntu-latest
    name: ä»£ç¢¼è³ªé‡æª¢æŸ¥

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é‹è¡Œæ¸¬è©¦è¦†è“‹ç‡
        run: pnpm test:coverage

      - name: æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡é–€æª»
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "ç•¶å‰æ¸¬è©¦è¦†è“‹ç‡: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "âŒ æ¸¬è©¦è¦†è“‹ç‡ä½æ–¼ 70% é–€æª»"
            exit 1
          else
            echo "âœ… æ¸¬è©¦è¦†è“‹ç‡é”åˆ°é–€æª»è¦æ±‚"
          fi

      - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # å®‰å…¨æª¢æŸ¥
  security:
    needs: setup-and-check
    runs-on: ubuntu-latest
    name: å®‰å…¨æª¢æŸ¥

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é‹è¡Œå®‰å…¨å¯©è¨ˆ
        run: pnpm audit --audit-level moderate

      - name: æª¢æŸ¥ä¾è³´æ¼æ´
        run: |
          if pnpm audit --audit-level moderate; then
            echo "âœ… æœªç™¼ç¾é«˜é¢¨éšªå®‰å…¨æ¼æ´"
          else
            echo "âš ï¸ ç™¼ç¾å®‰å…¨æ¼æ´ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®å¾©"
            exit 1
          fi

  # ä¸Šå‚³æ§‹å»ºç”¢ç‰©
  upload-artifacts:
    needs: [build, code-quality, security]
    runs-on: ubuntu-latest
    name: ä¸Šå‚³æ§‹å»ºç”¢ç‰©

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: Prepare deployment artifact
        run: |
          echo "Preparing deployment bundle..."
          mkdir -p deployment/web deployment/api

          echo "Listing apps/web contents"
          ls -al apps/web || true

          echo "Listing apps/api contents"
          ls -al apps/api || true

          if [ ! -d "apps/web/.next" ]; then
            echo "Next.js build output not found at apps/web/.next"
            exit 1
          fi

          if [ ! -d "apps/api/dist" ]; then
            echo "API build output not found at apps/api/dist"
            exit 1
          fi

          cp -r apps/web/.next deployment/web/
          cp -r apps/api/dist deployment/api/
          cp package.json deployment/
          cp pnpm-lock.yaml deployment/
          cp pnpm-workspace.yaml deployment/

      - name: ä¸Šå‚³éƒ¨ç½²åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment/
          retention-days: 7

      - name: æ§‹å»ºå®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ æ§‹å»ºå’Œæ¸¬è©¦å®Œæˆï¼"
          echo "æ§‹å»ºæ™‚é–“: $(date)"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æ§‹å»ºç”¢ç‰©å·²ä¸Šå‚³ï¼Œè«‹ä½¿ç”¨å°ˆé–€çš„éƒ¨ç½²å·¥ä½œæµç¨‹é€²è¡Œéƒ¨ç½²"

  # é–‹ç™¼ç’°å¢ƒéƒ¨ç½²é€šçŸ¥
  dev-notification:
    if: github.ref == 'refs/heads/develop'
    needs: [upload-artifacts]
    runs-on: ubuntu-latest
    name: é–‹ç™¼ç’°å¢ƒéƒ¨ç½²é€šçŸ¥

    steps:
      - name: æ§åˆ¶å°æé†’ (é–‹ç™¼ç’°å¢ƒ)
        run: |
          echo "âœ… é–‹ç™¼ç’°å¢ƒéƒ¨ç½²è§¸ç™¼"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è«‹ä½¿ç”¨ dev-deploy.yml å·¥ä½œæµç¨‹é€²è¡Œéƒ¨ç½²"

  # ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²é€šçŸ¥
  production-notification:
    if: github.ref == 'refs/heads/main'
    needs: [upload-artifacts]
    runs-on: ubuntu-latest
    name: ç”¢ç·šç’°å¢ƒéƒ¨ç½²é€šçŸ¥

    steps:
      - name: æ§åˆ¶å°æé†’ (ç”¢ç·šç’°å¢ƒ)
        run: |
          echo "âœ… ç”¢ç·šç’°å¢ƒéƒ¨ç½²è§¸ç™¼"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è«‹ä½¿ç”¨ production-deploy.yml å·¥ä½œæµç¨‹é€²è¡Œéƒ¨ç½²"

  # æ§‹å»ºå®Œæˆç¸½çµ
  build-summary:
    if: always()
    needs: [upload-artifacts, dev-notification, production-notification]
    runs-on: ubuntu-latest
    name: æ§‹å»ºå®Œæˆç¸½çµ

    steps:
      - name: æ§‹å»ºç‹€æ…‹ç¸½çµ
        run: |
          echo "ğŸ“Š CI/CD æ§‹å»ºç‹€æ…‹ç¸½çµ..."
          echo "æ§‹å»ºç”¢ç‰©: ${{ needs.upload-artifacts.result || 'skipped' }}"
          echo "é–‹ç™¼ç’°å¢ƒé€šçŸ¥: ${{ needs.dev-notification.result || 'skipped' }}"
          echo "ç”Ÿç”¢ç’°å¢ƒé€šçŸ¥: ${{ needs.production-notification.result || 'skipped' }}"

      - name: ç™¼é€æ§‹å»ºå ±å‘Š
        if: always()
        run: |
          echo "ğŸ“§ ç™¼é€æ§‹å»ºå ±å‘Š..."
          echo "ğŸ‰ CI éšæ®µå®Œæˆï¼Œè«‹ä½¿ç”¨å°ˆé–€çš„éƒ¨ç½²å·¥ä½œæµç¨‹é€²è¡Œéƒ¨ç½²"
