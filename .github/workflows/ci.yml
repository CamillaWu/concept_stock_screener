name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # ä¾è³´å®‰è£å’Œé¡å‹æª¢æŸ¥
  setup-and-check:
    runs-on: ubuntu-latest
    name: ç’°å¢ƒè¨­ç½®å’Œæª¢æŸ¥

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é¡å‹æª¢æŸ¥
        run: pnpm type-check

      - name: ä»£ç¢¼é¢¨æ ¼æª¢æŸ¥
        run: pnpm lint:check

      - name: ä»£ç¢¼æ ¼å¼åŒ–æª¢æŸ¥
        run: pnpm format:check

  # æ§‹å»ºæ¸¬è©¦
  build:
    needs: setup-and-check
    runs-on: ubuntu-latest
    name: æ§‹å»ºå’Œæ¸¬è©¦

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: æ§‹å»ºåŸºç¤åŒ…
        run: |
          pnpm build:types
          pnpm build:ui

      - name: æ§‹å»ºå‰ç«¯
        run: pnpm build:web

      - name: æ§‹å»º API
        run: pnpm build:api

      - name: é‹è¡Œæ¸¬è©¦
        run: pnpm test:ci

      - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ä»£ç¢¼è³ªé‡æª¢æŸ¥
  code-quality:
    needs: setup-and-check
    runs-on: ubuntu-latest
    name: ä»£ç¢¼è³ªé‡æª¢æŸ¥

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é‹è¡Œæ¸¬è©¦è¦†è“‹ç‡
        run: pnpm test:coverage

      - name: æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡é–€æª»
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "ç•¶å‰æ¸¬è©¦è¦†è“‹ç‡: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "âŒ æ¸¬è©¦è¦†è“‹ç‡ä½æ–¼ 70% é–€æª»"
            exit 1
          else
            echo "âœ… æ¸¬è©¦è¦†è“‹ç‡é”åˆ°é–€æª»è¦æ±‚"
          fi

      - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # å®‰å…¨æª¢æŸ¥
  security:
    needs: setup-and-check
    runs-on: ubuntu-latest
    name: å®‰å…¨æª¢æŸ¥

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: é‹è¡Œå®‰å…¨å¯©è¨ˆ
        run: pnpm audit --audit-level moderate

      - name: æª¢æŸ¥ä¾è³´æ¼æ´
        run: |
          if pnpm audit --audit-level moderate; then
            echo "âœ… æœªç™¼ç¾é«˜é¢¨éšªå®‰å…¨æ¼æ´"
          else
            echo "âš ï¸ ç™¼ç¾å®‰å…¨æ¼æ´ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®å¾©"
            exit 1
          fi

  # éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
  deploy-dev:
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development')
    needs: [build, code-quality, security]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
    environment: development

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: æ§‹å»ºæ‡‰ç”¨
        run: |
          pnpm build:types
          pnpm build:ui
          pnpm build:web
          pnpm build:api

      - name: å‰µå»ºéƒ¨ç½²åŒ…
        run: |
          mkdir -p deployment
          cp -r apps/web/.next deployment/web/
          cp -r apps/api/dist deployment/api/
          cp package.json deployment/
          cp pnpm-lock.yaml deployment/
          cp pnpm-workspace.yaml deployment/

      - name: ä¸Šå‚³éƒ¨ç½²åŒ…
        uses: actions/upload-artifact@v3
        with:
          name: deployment-package
          path: deployment/
          retention-days: 7

      - name: éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ..."
          echo "éƒ¨ç½²æ™‚é–“: $(date)"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„éƒ¨ç½²é‚è¼¯
          # ä¾‹å¦‚ï¼šä¸Šå‚³åˆ°é–‹ç™¼æœå‹™å™¨ã€éƒ¨ç½²åˆ° Vercel ç­‰

          echo "âœ… é–‹ç™¼ç’°å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: ç™¼é€éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ é–‹ç™¼ç’°å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ é–‹ç™¼ç’°å¢ƒéƒ¨ç½²å¤±æ•—"
          fi

  # éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
  deploy-staging:
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    needs: [build, code-quality, security]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
    environment: staging

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: æ§‹å»ºæ‡‰ç”¨
        run: |
          pnpm build:types
          pnpm build:ui
          pnpm build:web
          pnpm build:api

      - name: éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ..."
          echo "éƒ¨ç½²æ™‚é–“: $(date)"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„éƒ¨ç½²é‚è¼¯

          echo "âœ… æ¸¬è©¦ç’°å¢ƒéƒ¨ç½²å®Œæˆ"

  # éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-production:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    needs: [build, code-quality, security]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    environment: production

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: æ§‹å»ºæ‡‰ç”¨
        run: |
          pnpm build:types
          pnpm build:ui
          pnpm build:web
          pnpm build:api

      - name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
          echo "éƒ¨ç½²æ™‚é–“: $(date)"
          echo "Git æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"

          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„éƒ¨ç½²é‚è¼¯

          echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆ"

  # éƒ¨ç½²å¾Œæª¢æŸ¥
  post-deploy-check:
    if: always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'failure'))
    needs: [deploy-dev, deploy-staging, deploy-production]
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å¾Œæª¢æŸ¥

    steps:
      - name: æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹
        run: |
          echo "ğŸ“Š éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥..."
          echo "é–‹ç™¼ç’°å¢ƒ: ${{ needs.deploy-dev.result || 'skipped' }}"
          echo "æ¸¬è©¦ç’°å¢ƒ: ${{ needs.deploy-staging.result || 'skipped' }}"
          echo "ç”Ÿç”¢ç’°å¢ƒ: ${{ needs.deploy-production.result || 'skipped' }}"

          # é€™è£¡å¯ä»¥æ·»åŠ å¥åº·æª¢æŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šæª¢æŸ¥æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œã€API æ˜¯å¦éŸ¿æ‡‰ç­‰

      - name: ç™¼é€éƒ¨ç½²å ±å‘Š
        if: always()
        run: |
          echo "ğŸ“§ ç™¼é€éƒ¨ç½²å ±å‘Š..."
          # é€™è£¡å¯ä»¥æ·»åŠ é€šçŸ¥é‚è¼¯
          # ä¾‹å¦‚ï¼šç™¼é€ Slack é€šçŸ¥ã€éƒµä»¶ç­‰
